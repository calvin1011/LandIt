<!DOCTYPE html>
<html lang="en">
<head>
    <title>Firebase Auth Test</title>
    <script type="module">
        import { login, signup, logout, onAuthChange } from "./auth.js";

        // Signup
        window.handleSignup = async function () {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            try {
                await signup(email, password);
                alert("Signup successful!");
            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        // Login
        window.handleLogin = async function () {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            try {
                const user = await login(email, password);
                const token = await user.getIdToken();
                console.log("Firebase Token:", token);
                localStorage.setItem("firebaseToken", token);
                alert("Login successful!");
            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        // Logout
        window.handleLogout = async function () {
            try {
                await logout();
                localStorage.removeItem("firebaseToken");
                console.log("User logged out. Token cleared.");
                alert("User logged out!");
            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        // Auth state changes
        onAuthChange(user => {
            document.getElementById("status").innerText = user
                ? `Logged in as: ${user.email}`
                : "Not logged in";
            if (user) {
                user.getIdToken().then(token => {
                    console.log("Firebase Token (onAuthChange):", token);
                    localStorage.setItem("firebaseToken", token);
                });
            }
        });

        window.testBackendAuth = async function () {
            const token = localStorage.getItem("firebaseToken");
            if (!token) {
                document.getElementById("backendResult").textContent = "No token found. Please login first.";
                return;
            }

            try {
                const response = await fetch("http://localhost:5000/api/auth/user", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById("backendResult").textContent =
                        "Authenticated!\n" + JSON.stringify(data, null, 2);
                } else {
                    document.getElementById("backendResult").textContent =
                        ` ${response.status} - ${data.error}`;
                }
            } catch (err) {
                document.getElementById("backendResult").textContent = "Error: " + err.message;
            }
        };
    </script>
</head>
<body>
<h2>Firebase Auth Test</h2>
<p id="status">Checking login status...</p>

<label for="email"></label><input type="email" id="email" placeholder="Email">
<label for="password"></label><input type="password" id="password" placeholder="Password">

<button onclick="handleSignup()">Signup</button>
<button onclick="handleLogin()">Login</button>
<button onclick="handleLogout()">Logout</button>

<hr />
<button onclick="testBackendAuth()">Test Protected Backend Route</button>
<pre id="backendResult"></pre>
</body>
</html>
